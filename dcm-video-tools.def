Bootstrap: docker
From: ubuntu:22.04

%labels
    Maintainer "hodgem@wustl.edu"
    Purpose    "DICOM raw RGB â†’ masked video/DICOM pipeline"

%help
Usage:
  apptainer exec --bind "$PWD":/work dcm-video-tools.sif \
    dicom_video_anonymization -i /work/input -o /work/output -n 8

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PATH=/opt/app:$PATH

# >>> Copy files from host into the image (relative to the .def file) <<<
%files
    dicom_video_anonymization/dicom_video_anonymization.sh /opt/app/dicom_video_anonymization

%post
    set -eux
    export DEBIAN_FRONTEND=noninteractive

    apt-get update
    apt-get install -y --no-install-recommends \
        bash coreutils findutils grep sed gawk procps file jq \
        python3 python3-pip ffmpeg dcmtk
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    pip3 install --no-cache-dir pydicom

    chmod 755 /opt/app/dicom_video_anonymization

%test
    set -eux
    test -x /opt/app/dicom_video_anonymization
    dcmdump --version | head -n1
    ffmpeg -version | head -n1
    python3 -c 'import pydicom,sys; print("pydicom", pydicom.__version__)'

%runscript
    cd /work 2>/dev/null || true
    exec /opt/app/dicom_video_anonymization "$@"

